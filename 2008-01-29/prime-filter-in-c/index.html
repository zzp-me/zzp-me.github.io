<!DOCTYPE html PUBLIC
 "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:wb="http://open.weibo.com/wb">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="author" content="redraiment@gmail.com" />
    <meta name="keywords" content="redraiment,张泽鹏,iKnowledge" />
    <meta name="description" content="使用筛法求2-N之间的所有素数" />

    <title>筛法求素数 - 子清行 - zzp.me</title>

    <link rel="shortcut icon" type="image/png" href="/resource/image/fav.png" />
    <link rel="apple-touch-icon" sizes="57x57" type="image/png" href="/resource/image/apple-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="114x114" type="image/png" href="/resource/image/apple-icon-114x114.png" />

    <link rel="stylesheet" type="text/css" href="/resource/style/iKnowledge.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/resource/style/highlight.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/resource/style/article.css" media="screen" />

    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=1192214979" type="text/javascript" charset="utf-8"></script>
    <script language="JavaScript" type="text/javascript" src="/resource/script/iKnowledge.js"></script>
    <script language="JavaScript" type="text/javascript" src="http://www.google-analytics.com/ga.js"></script>
  </head>
  <body>
    <a name="top"></a>
    <div id="container">
      <div id="logo">
        <input id="search" type="text" value="站内搜索" onkeyup="doSearch(event);" onfocus="doFocus();" onblur="doBlur();"/>
        <h1>
          <a href="/">子清行 - zzp.me</a>
        </h1>
        <h2>黑夜中孤守一轮明月|喧闹中独享一份清闲</h2>
      </div>
      <div id="navigate">
        <img width="200" height="200" src="/resource/image/avatar.gif" />
        <div id="bio">
          <a href="/">我是张泽鹏</a>
          <div>邮箱：<a href="mailto:redraiment@gmail.com">redraiment@gmail</a></div>
          <div>微博：<a href="http://weibo.com/redraiment">@redraiment</a></div>
        </div>
        <div class="widget">
          <h1>分类归档</h1>
          <ul><li><a href="/archive/我是程序员.html">我是程序员(9)</a><ul><li><a href="/archive/我的世界观.html">我的世界观(13)</a></li><li><a href="/archive/幸福生活.html">幸福生活(12)</a></li></ul></li><li><a href="/archive/编程语言生态.html">编程语言生态(7)</a><ul><li><a href="/archive/c语言.html">C语言(3)</a><ul><li><a href="/archive/c语言实验报告.html">实验报告(9)</a></li></ul></li><li><a href="/archive/javascript.html">JavaScript(1)</a><ul><li><a href="/archive/e4x.html">E4X(6)</a></li><li><a href="/archive/服务端js.html">服务端JS(2)</a></li></ul></li><li><a href="/archive/lisp.html">Lisp(3)</a></li></ul></li><li><a href="#">代码分享</a><ul><li><a href="/archive/基础算法.html">基础算法(5)</a></li><li><a href="#">数据结构</a></li><li><a href="/archive/杭电100题.html">杭电100题(100)</a></li><li><a href="/archive/设计模式.html">设计模式(2)</a></li><li><a href="/archive/加密解密.html">加密解密(1)</a></li><li><a href="/archive/图像处理.html">图像处理(1)</a></li><li><a href="/archive/正则表达式.html">正则表达式(1)</a></li><li><a href="/archive/lambda演算.html">Lambda演算(1)</a></li><li><a href="#">解释器</a><ul><li><a href="/archive/basic解释器.html">BASIC解释器(5)</a></li><li><a href="/archive/brainfuck.html">BrainFuck(1)</a></li></ul></li></ul></li><li><a href="#">工具技师</a><ul><li><a href="/archive/命令行超级工具.html">命令行超级工具(7)</a></li><li><a href="/archive/autohotkey.html">AutoHotKey(1)</a></li><li><a href="/archive/clearcase.html">ClearCase(2)</a></li><li><a href="/archive/db2.html">DB2(6)</a></li><li><a href="/archive/emacs.html">Emacs(3)</a></li><li><a href="/archive/jekyll.html">Jekyll(1)</a></li></ul></li><li><a href="#">软件项目</a><ul><li><a href="/archive/iknowledge.html">iKnowledge(4)</a></li><li><a href="/archive/好友买卖外挂.html">好友买卖外挂(3)</a></li><li><a href="/archive/金山词霸生词本转换器.html">金山词霸生词本转换器(2)</a></li><li><a href="/archive/双向管道.html">双向管道(11)</a></li><li><a href="/archive/smallc.html">SmallC(1)</a></li><li><a href="/archive/中文计算器.html">中文计算器(2)</a></li></ul></li></ul>
        </div>
        <div class="widget">
          <h1>时间归档</h1>
          <ul><li><a href="#">2013年</a><ul><li><a href="/archive/2013-12.html">12月(1)</a></li><li><a href="/archive/2013-11.html">11月(11)</a></li><li><a href="/archive/2013-09.html">09月(1)</a></li><li><a href="/archive/2013-08.html">08月(1)</a></li><li><a href="/archive/2013-04.html">04月(1)</a></li><li><a href="/archive/2013-03.html">03月(1)</a></li><li><a href="/archive/2013-01.html">01月(1)</a></li></ul></li><li><a href="#">2012年</a><ul><li><a href="/archive/2012-10.html">10月(1)</a></li><li><a href="/archive/2012-09.html">09月(1)</a></li><li><a href="/archive/2012-08.html">08月(4)</a></li><li><a href="/archive/2012-06.html">06月(1)</a></li><li><a href="/archive/2012-04.html">04月(1)</a></li><li><a href="/archive/2012-03.html">03月(1)</a></li></ul></li><li><a href="#">2011年</a><ul><li><a href="/archive/2011-11.html">11月(1)</a></li><li><a href="/archive/2011-09.html">09月(1)</a></li><li><a href="/archive/2011-08.html">08月(2)</a></li><li><a href="/archive/2011-07.html">07月(2)</a></li><li><a href="/archive/2011-06.html">06月(10)</a></li><li><a href="/archive/2011-03.html">03月(1)</a></li><li><a href="/archive/2011-02.html">02月(2)</a></li><li><a href="/archive/2011-01.html">01月(1)</a></li></ul></li><li><a href="#">2010年</a><ul><li><a href="/archive/2010-08.html">08月(1)</a></li><li><a href="/archive/2010-05.html">05月(1)</a></li><li><a href="/archive/2010-02.html">02月(1)</a></li><li><a href="/archive/2010-01.html">01月(4)</a></li></ul></li><li><a href="#">2009年</a><ul><li><a href="/archive/2009-12.html">12月(2)</a></li><li><a href="/archive/2009-11.html">11月(6)</a></li><li><a href="/archive/2009-10.html">10月(4)</a></li><li><a href="/archive/2009-09.html">09月(9)</a></li><li><a href="/archive/2009-08.html">08月(9)</a></li><li><a href="/archive/2009-07.html">07月(8)</a></li><li><a href="/archive/2009-06.html">06月(2)</a></li><li><a href="/archive/2009-05.html">05月(1)</a></li><li><a href="/archive/2009-04.html">04月(2)</a></li><li><a href="/archive/2009-02.html">02月(1)</a></li><li><a href="/archive/2009-01.html">01月(1)</a></li></ul></li><li><a href="#">2008年</a><ul><li><a href="/archive/2008-10.html">10月(1)</a></li><li><a href="/archive/2008-09.html">09月(3)</a></li><li><a href="/archive/2008-08.html">08月(2)</a></li><li><a href="/archive/2008-07.html">07月(2)</a></li><li><a href="/archive/2008-06.html">06月(100)</a></li><li><a href="/archive/2008-03.html">03月(1)</a></li><li><a href="/archive/2008-02.html">02月(1)</a></li><li><a href="/archive/2008-01.html">01月(2)</a></li></ul></li><li><a href="#">2007年</a><ul><li><a href="/archive/2007-08.html">08月(2)</a></li><li><a href="/archive/2007-07.html">07月(1)</a></li><li><a href="/archive/2007-02.html">02月(10)</a></li></ul></li></ul>
        </div>
      </div>
      <div id="main">
        <div id="abstract">
          <h1>筛法求素数</h1>
        </div>
        <div id="content">
          <div class="tags">
  关键字：
  
  <a href="/archive/代码分享.html">代码分享</a>
  
  <a href="/archive/基础算法.html">基础算法</a>
  
</div>
<div id="article">
  <h1>问题描述</h1>

<p>试编写一个程序，找出 2-N 之间的所有素数。</p>

<h1>问题分析</h1>

<p>这个问题可以有两种解法：一种是用“筛法”，另一种是除余法。本文使用筛法，“除余法”详情请参见《<a href="/2008-01-29/prime-div-in-c/">除余法求素数</a>》。</p>

<p>先通过一个简单的例子来介绍一下“筛法”，求 2-20 的素数，它的做法是先把 2-20 这些数一字排开：</p>

<blockquote>
<p>2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20</p>
</blockquote>

<p>取出数组中最小的数 2，把后面 2 的倍数全部删掉。</p>

<blockquote>
<p>2 | 3 5 7 9 11 13 15 17 19</p>
</blockquote>

<p>接下来取出最小数 3，并删除 3 的倍数。</p>

<blockquote>
<p>2 3 | 5 7 11 13 17 19</p>
</blockquote>

<p>以此类推直至结束，剩余之数皆为素数。</p>

<h2>筛法的原理：</h2>

<ol>
<li>数字2是素数。</li>
<li>在数字K前，每找到一个素数，都会删除它的倍数，即以它为因子的整数。如果k未被删除，就表示2-&gt;k-1都不是k的因子，那k自然就是素数了。</li>
</ol>

<h2>算法优化</h2>

<ol>
<li>除余法那篇文章里也介绍了，要找出一个数的因子，其实不需要检查 2-k，只要从 2-&gt;sqrt(k)，就可以了。所有，我们筛法里，其实只要筛到sqrt(n)就已经找出所有的素数了，其中n为要搜索的范围。</li>
<li>另外，我们不难发现，每找到一个素数 k，就一次删除 2k, 3k, 4k,..., ik，不免还是有些浪费，因为2k已经在找到素数2的时候删除过了，3k已经在找到素数3的时候删除了。因此，当 i＜k 时，都已经被前面的素数删除过了，只有那些最小的质因子是k的那些数还未被删除过，所有，就可以直接从 k*k 开始删除。</li>
<li>再有，所有的素数中，除了 2 以外，其他的都是奇数，那么，当 i 是奇数的时候，ik 就是奇数，此时 <code>k*k+ik</code> 就是个偶数，偶数已经被2删除了，所有我们就可以以2k为单位删除步长，依次删除 <code>k*k</code>, <code>k*k+2k</code>, <code>k*k+4k</code>, ...。</li>
<li>我们都清楚，在前面一小段范围内，素数是比较集中的，比如 1-100 之间就有25个素数。越到后面就越稀疏。</li>
</ol>

<p>因为这些素数本身值比较小，所以搜索范围内，大部分数都是它们的倍数，比如搜索 1-100，这 100 个数。光是 2 的倍数就有 50 个，3 的倍数有 33 个，5的倍数 20 个，7 的倍数 14 个。我们只需搜索到7就可以，因此一共做删除操作50+33+20+14=117次，而 2 和 3 两个数就占了 83 次，这未免太浪费时间了。</p>

<p>所以我们考虑，能不能一开始就排除这些小素数的倍数，这里用 2 和 3 来做例子。</p>

<p>如果仅仅要排除 2 的倍数，数组里只保存奇数：1、3、5...，那数字 k 的坐标就是 k/2。</p>

<p>如果我们要同时排除 2 和 3 的倍数，因为 2 和 3 的最小公倍数是 6，把数字按 6 来分组：6n, 6n+1, 6n+2, 6n+3, 6n+4, 6n+5。其中 6n, 6n+2, 6n+4 是 2 的倍数，6n+3 是 3 的倍数。所以数组里将只剩下 6n+1 和 6n+5。n 从 0 开始，数组里的数字就一次是 1, 5, 7, 11, 13, 17...。</p>

<p>现在要解决的问题就是如何把数字 k 和它的坐标 i 对应起来。比如，给出数字 89，它在数组中的下标是多少呢？不难发现，其实上面的序列，每两个为一组，具有相同的基数 n，比如 1 和 5 ，同是 n=0 那组数，<code>6*0+1</code> 和 <code>6*0+5</code>；31 和 35 同是n=5那组，<code>6*5+1</code> 和 <code>6*5+5</code>。所以数字按6分组，每组2个数字，余数为5的数字在后，所以坐标需要加 1。</p>

<p>所以 89 在第 89/6=14 组，坐标为 <code>14*2=28</code>，又因为 89%6==5，所以在所求的坐标上加 1，即 28+1=29，最终得到 89 的坐标 i=29。同样，找到一个素数 k 后，也可以求出 <code>k*k</code> 的坐标等，就可以做筛法了。</p>

<p>这里，我们就需要用 k 做循环变量了，k 从 5 开始，交替与 2 和 4 相加，即先是 5+2=7，再是 7+4=11，然后又是 11+2=13...。这里我们可以再设一个变量gab，初始为 4，每次做 gab = 6 - gab，k += gab。让gab在2和4之间交替变化。另外，2 和 4 都是 2 的幂，二进制分别为10和100，6的二进制位110，所以可以用 k += gab ^= 6来代替。参考代码：</p>
<div class="highlight"><pre><code class="c language-c" data-lang="c"><span class="n">gab</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">k</span> <span class="o">*</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="n">gab</span> <span class="o">^=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>但我们一般都采用下标 i 从 0-x 的策略，如果用 i 而不用 k，那应该怎么写呢？</p>

<p>由优化策略(1)可知，我们只要从 k<sup>2</sup>开始筛选。 n=i/2，我们知道了 i 对应的数字 k 是素数后，根据(2)，那如何求得 k<sup>2</sup>的坐标 j 呢？这里假设 i 为偶数，即 k=6n+1。</p>

<p>k<sup>2</sup>= (6n+1)*(6n+1) = 36n<sup>2</sup>+ 12n + 1，其中 36n<sup>2</sup>+12n = 6(6n<sup>2</sup>+2n) 是6的倍数，所以 k<sup>2</sup>除 6 余 1。</p>

<p>所以 k<sup>2</sup>的坐标 j = k<sup>2</sup>/6*2 = 12n<sup>2</sup>+4n。</p>

<p>由优化策略(2)可知，我们只要依次删除 k<sup>2</sup>+2l&times;k, l = 0, 1, 2...。即 (6n+1)&times;(6n+1+2l)。</p>

<p>我们发现，但l=1, 4, 7...时，(6n+1+2l)是3的倍数，不在序列中。所以我们只要依次删除 k<sup>2</sup>, k<sup>2</sup>+4l, k<sup>2</sup>+4l+2l...，又是依次替换2和4。</p>

<p>为了简便，我们可以一次就删除 k<sup>2</sup>和 k<sup>2</sup>+4l 两项，然后步长增加6l。所以我们需要求 len=4l 和 stp=6l。不过这里要注意一点，k<sup>2</sup>+4k=(6n+1)*(6n+5)，除以6的余数是5，坐标要加1。</p>

<pre>len = k*(k+4)/6*2 - k<sup>2</sup>/6*2 = (6n+1)*(6n+1+4)/6*2+1 - (6n+1)*(6n+1)/6*2 = (12n<sup>2</sup>+12n+1) - (12n<sup>2</sup>+4n) = 8n+1;
stp = k*(k+6)/6*2 - k<sup>2</sup>/6*2 = 12n+2;</pre>

<p>最终，我们得到：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">len = 8n+1;
stp = 12n+2;
  j = 12n2+4n;
</code></pre></div>
<p>同理可以求出 k=6n+5 时的情况：</p>

<pre>len = 4n+3;
stp = 12n+10;
  j = 12n<sup>2</sup>+20n+8;</pre>

<p>下面的代码在实现上用了位运算，可能有点晦涩。</p>

<p>★注：第5种优化方法还是理论阶段，下面的代码中并未采用这种优化算法，仅供大家参考。</p>

<p>由(2)可知，如果每找到一个素数k，能依次只删除以k为最小素数因子的数，那么每个数字就都只被删除一次，那这个筛法就能达到线性的 O(n) 效率了。比如数字 <code>600 = 2*2*3*5*11</code>，其中 2 是它的最小素数因子。那这个数就被 2 删除了。3、5、11虽然都是它的因子，但不做删除它的操作。要实现这种策略，那每找到一个素数 k，那从 k 开始，一次后面未被删除的数字来与 k 相乘，删除它们的积。比如要筛出 2～60 之间的素数：</p>

<p><code>1.</code> 先列出所有的数。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">02 03 04 05 06 07 08 09 10 11 12 13 14 15 ... 50 51 52 53 54 55 56 57 58 59 60
</code></pre></div>
<p><code>2.</code> 选出序列中的第一个数 2，判定它是素数，然后从 2 开始，依次与剩下的未被删除的数相乘，删除它们的积。即 <code>2*2=4</code>， <code>2*3=6</code>，<code>2*4=8</code>...。</p>

<pre>02 03 <span style="text-decoration: line-through;">04</span> 05 <span style="text-decoration: line-through;">06</span> 07 <span style="text-decoration: line-through;">08</span> 09 <span style="text-decoration: line-through;">10</span> 11 <span style="text-decoration: line-through;">12</span> 13 <span style="text-decoration: line-through;">14</span> 15 ... <span style="text-decoration: line-through;">50</span> 51 <span style="text-decoration: line-through;">52</span> 53 <span style="text-decoration: line-through;">54</span> 55 <span style="text-decoration: line-through;">56</span> 57 <span style="text-decoration: line-through;">58</span> 59 <span style="text-decoration: line-through;">60</span>
02 | 03 05 07 09 11 13 15 17 19 21 23 25 27 29 31 33 35 37 39 41 43 45 47 49 51 53 55 57 59</pre>

<p><code>3.</code> 去掉 2 后，再选出序列中第一个数 3，判定它是素数，然后从 3 开始，依次与剩下的数相乘，即 <code>3*3=9</code>，<code>3*5=15</code>，<code>3*7=21</code>...</p>

<pre>02 | 03 05 07 <span style="text-decoration: line-through;">09</span> 11 13 <span style="text-decoration: line-through;">15</span> 17 19 <span style="text-decoration: line-through;">21</span> 23 25 <span style="text-decoration: line-through;">27</span> 29 31 <span style="text-decoration: line-through;">33</span> 35 37 <span style="text-decoration: line-through;">39</span> 41 43 <span style="text-decoration: line-through;">45</span> 47 49 <span style="text-decoration: line-through;">51</span> 53 55 <span style="text-decoration: line-through;">57</span> 59
02 03 | 05 07 11 13 17 19 23 25 29 31 35 37 41 43 47 49 53 55 59</pre>

<p><code>4.</code> 去掉3后，选出最小的数5，判定它为素数，依次删除 <code>5*5=25</code>，<code>5*7=35</code>，<code>5*11=55</code>，...</p>

<pre>02 03 | 05 07 11 13 17 19 23 <span style="text-decoration: line-through;">25</span> 29 31 <span style="text-decoration: line-through;">35</span> 37 41 43 47 49 53 <span style="text-decoration: line-through;">55</span> 59
02 03 05 | 07 11 13 17 19 23 29 31 37 41 43 47 49 53 59</pre>

<p><code>5.</code> 去掉5后，选出最小的数7，为素数，删除7*7=49，...</p>

<pre>02 03 05 | 07 11 13 17 19 23 29 31 37 41 43 47 <span style="text-decoration: line-through;">49</span> 53 59
02 03 05 | 07 11 13 17 19 23 29 31 37 41 43 47 53 59</pre>

<p><code>6.</code> 去掉7后，第一个数 11 的平方 121 大于 60，所以结束。剩下的数字全为素数。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">02 03 05 07 11 13 17 19 23 29 31 37 41 43 47 53 59 |
</code></pre></div>
<p>上面的操作效率很高，但在计算机中模拟的时候却又很大的障碍：</p>

<p>首先，计算机内存是一维的空间，很多时候我们不能随心所欲，要实现上面的算法，要求这个数据结构既能很高效地查找某个特定的值，又能不费太大代价对序列中的元素进行删除。高效地查找，用数组是最合适的了，能在 O(1) 的时间内对内存进行读写，但要删除序列中一个元素却要 O(n)；单链表可以用 O(1) 的时间做删除操作，当然要查找就只能是 O(n) 了。所以这个数据结构很难找。</p>

<p>其次，筛法的一个缺点就是空间浪费太大，典型的以空间换时间。如果我们对数组进行压缩，比如初始时就排除了所有偶数，数组 0对应数字1，1对应3，...。这样又会因为多了一道计算数字下标的工序而浪费时间。这又是一个矛盾的问题。</p>

<p>也许我们可以试试折中的办法：数据结构综合数组和链表 2 种，数组用来做映射记录，链表来记录剩下的还未被删除的数据，而且开始也不必急着把链表里的节点释放掉，只要在数组里做个标记就可以了。下次遍历到这个数字时才删除。这样为了删除，可以算只遍历了一次链表，不过频繁地使用free()函数，也许又会减低效率。总之，我们所做的，依然是用空间来换时间，记录更多的信息，方便下次使用，减少再次生成信息所消耗的时间。</p>

<h1>程序清单</h1>
<div class="highlight"><pre><code class="c language-c" data-lang="c"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;time.h&gt;</span>

<span class="cp">#define N 100000000</span>
<span class="cp">#define size (N/6*2 + (N%6 == 5? 2: (N%6&gt;0)))</span>

<span class="kt">int</span> <span class="n">p</span><span class="p">[</span><span class="n">size</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="kt">int</span> <span class="nf">creat_prime</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">stp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="o">:</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">stp</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="mi">10</span><span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="p">((</span><span class="n">i</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">len</span><span class="o">:</span> <span class="n">len</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">stp</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">p</span><span class="p">[</span><span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">),</span> <span class="o">--</span><span class="n">c</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[(</span><span class="n">j</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">p</span><span class="p">[(</span><span class="n">j</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">),</span> <span class="o">--</span><span class="n">c</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="p">[(</span><span class="n">j</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">^</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">p</span><span class="p">[(</span><span class="n">j</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">),</span> <span class="o">--</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">clock_t</span> <span class="n">t</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">creat_prime</span><span class="p">());</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Time: %f &quot;</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">CLOCKS_PER_SEC</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h1>运行结果</h1>
<div class="highlight"><pre><code class="text language-text" data-lang="text">5761455
Time: 0.300000
</code></pre></div>
<p>运行环境：Linux debian 2.6.26-1-686、GCC (Debian 4.3.2-1.1) 4.3.2、Intel Core 2、512MB RAM</p>

<h1>算法比较</h1>

<p>现在，我们已经拥有初步改进的“筛法”和“除余法”的函数了，把它们加到自己的函数库里。方便下次调用。这里，我想说一下个人对这两种算法的使用经验：</p>

<p>就时间效率上讲，筛法绝对比除余法高。比如上面的代码，可以在半秒内筛一亿以内的所有素数。如果用除余法来解决这样的问题，绝对可以考验一个人的耐性。因此，在搜索空间比较大的时候，“筛法”无疑会是首选。</p>

<p>但筛法是以空间换时间，用除余法，我们只要开一个可以容纳结果的数组就可以了，而筛法开的数组要求可以容纳整个搜索范围；另外，我们用“除余法”得到的结果，是一个已经排好序的素数序列，如果要解决的问题需要用到这些连续的素数，而且搜索范围也不大，那显然除余法很适合。而“筛法”得到的结果，是一个布尔型的表格，通过它，你可以很轻松的判断某个数是不是素数，但如果你想知道这个素数的下一个素数是多大，可能要费点劲了。</p>

</div>
<div id="log">
  
  <div class="record">
    <a href="mailto:redraiment+zzp.me@gmail.com">zzp-me</a>：
    <span class="message">求素数</span>
    <label class="timestamp">[2013-12-05 19:58:59]</label>
  </div>
  
</div>

        </div>
        <wb:comments url="auto" fontsize="14" width="auto" skin="silver" appkey="1192214979" ralateuid="1776428432"></wb:comments>
      </div>
      <div id="copyright">
        <p>&copy; 2012-2013 张泽鹏 &lt;redraiment@gmail.com&gt; - 子清行 - zzp.me</p>
      </div>
    </div>
  </body>
</html>
